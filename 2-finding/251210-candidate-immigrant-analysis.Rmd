---
title: "Analysis Candidate Experiment Data with OLS, Logistic Model and Conditional Logistic Model"
author: "Wei-Lun, Lin"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)  # data processing
library(broom)
library(kableExtra)  # print table
library(survival)

library(sandwich)
library(lmtest)
library(multiwayvcov)

source("./0-code/functions.R")
```

-   背景: 以 OLS, logistic regression, conditional logistic regression 分析 Hainmueller et al. (2014) 的 candidate experiment 資料。
-   結果: 的確可以得到相同的 AMCE，不過也發現在對每個受試者控制 cluster-robust standard error 後，logistic regression 所得到的 standard error 會和 conditional logistic regression 相差不大。
-   未來工作: 後續分析 immigrant experiment。


## Candidate Experiment

```{r import-data-candidate}
candidate <- read_rds("../1-data/2-processed/candidate_data.rds")
candidate %>% 
  head() %>% 
  kable("html", caption="First 6 Row of Candidate Data") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>% 
  scroll_box(width = "100%")
```

在 candidate experiment 中，candidate 有8個 attributes:

| Attribute | Level 1 | Level 2 | Level 3 | Level 4 | Level 5 | Level 6 |
|-----------|--------|---------------|--------|--------|-------------|-------------|
| Religion (6) | Catholic | Evangelical Protestant | Mainline Protestant | Mormon | Jewish | None |
| College education (6) | no college | state university | community college | Baptist college | Ivy League college | small college |
| Profession (6) | lawyer | high school teacher | business owner | farmer | doctor | car dealer |
| Annual income (6) | \$32K | \$54K | \$65K | \$92K | \$210K | \$5.1M |
| Racial/ethnic background (6) | Hispanic | White | Caucasian | Black | Asian American | Native American |
| Age (6) | 36 | 45 | 52 | 60 | 68 | 70 |
| Military service (6) | served | not served | \- | \- | \- | \- |
| Gender (6) | male | female | \- | \- | \- | \- |


## Model Fitting

```{r candidate-res-all}
est.all.candidate <- data.frame()
```


### Candidate: Linear Regression

```{r candidate-ols}
ols.candidate <- fit_model(
  select ~ MilitaryService. + Religion. + College. + Profession. + Income. + RaceEthnicity. + Age. + Gender.,
  dat = candidate, model = "ols"
)
ols.candidate.clus <- fit_model(
  select ~ MilitaryService. + Religion. + College. + Profession. + Income. + RaceEthnicity. + Age. + Gender.,
  dat = candidate, model = "ols", cluster = "subject"
)

est.all.candidate <- ols.candidate[[2]] %>% 
  select(-c(statistic, p.value)) %>% 
  mutate(
    CI.lower = estimate - 1.96*std.error,
    CI.upper = estimate + 1.96*std.error
  ) %>% 
  rename_with(~ paste0(.x, ".OLS"), .cols = -c(attribute, term))
est.all.candidate <- ols.candidate.clus[[2]] %>% 
  select(-c(statistic, p.value)) %>% 
  mutate(
    CI.lower = estimate - 1.96*std.error,
    CI.upper = estimate + 1.96*std.error
  ) %>% 
  rename_with(~ paste0(.x, ".OLS_clustered"), .cols = -c(attribute, term)) %>% 
  left_join(est.all.candidate, ., by = join_by(attribute, term))
```

<!-- Result of OLS. -->

```{r candidate-ols-res, include=F}
ols.candidate[[2]] %>%
  mutate(
    CI.lower = estimate - 1.96*std.error,
    CI.upper = estimate + 1.96*std.error
  ) %>% 
  mutate_if(is.numeric, ~ round(.x, 3)) %>% 
  kable("html", caption="Result of Linear Regression Model for Candidate Experiment") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  scroll_box(height = "500pt")
```


Plot the result of OLS, including clustered at subject and without clustering.

```{r candidate-ols-plot, warning=F, message=F}
ols.plot.candidate <- est.all.candidate %>% 
  select(c(attribute, term, contains("OLS"))) %>% 
  select(c(attribute, term, starts_with("estimate."), starts_with("CI."))) %>% 
  mutate(term = factor(term, levels = rev(term))) %>% 
  pivot_longer(
    cols = -c(attribute, term),
    names_to = c(".value", "model"),
    names_pattern = "(.*)\\.(OLS|OLS_clustered)$"
  ) %>%  
  mutate(
    model = fct_recode(model, "OLS without clustering" = "OLS", "OLS with subject clustered" = "OLS_clustered")
  ) %>%
  plot_result(., n.mod = 2) +
  labs(title = "Candidate Experiment Fitted by OLS", x = "AMCE")
  
ggsave("./1-figure/res-candidate-OLS.png", ols.plot.candidate)

ols.plot.candidate
```


### Logistic Regression

```{r candidate-logit}
logit.model <- glm(
    select ~ MilitaryService. + Religion. + College. + Profession. + Income. + RaceEthnicity. + Age. + Gender.,
    family = binomial(link = 'logit'),
    data = candidate
  )

logit.vcovCL <- cluster.vcov(logit.model, candidate$subject, df_correction = FALSE)
logit.candidate <- coeftest(logit.model, logit.vcovCL) %>%
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  separate_wider_delim(term, ".", names = c("attribute", "term"), too_many = "merge")

est.all.candidate <- logit.candidate %>% 
  select(-c(statistic, p.value)) %>% 
  mutate(
    CI.lower = estimate - 1.96*std.error,
    CI.upper = estimate + 1.96*std.error
  ) %>% 
  rename_with(~ paste0(.x, ".logit"), .cols = -c(attribute, term)) %>% 
  left_join(est.all.candidate, ., by = join_by(attribute, term))
```

Result of logistic regression.

```{r candidate-logit-res}
logit.candidate %>%
  mutate_if(is.numeric, ~ round(.x, 3)) %>% 
  kable("html", caption="Result of Logit Regression Model for Candidate Experiment") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  scroll_box(height = "500pt")
```


Plot the result of logistic regression.

```{r candidate-logit-plot, warning=F, message=F}
logit.plot.candidate <- logit.candidate %>% 
  mutate(term = factor(term, levels = rev(term))) %>% 
  ggplot(aes(x = estimate, y = term, color = attribute)) +
  geom_point(
    position = position_dodge(width = 0.7),
    alpha = .7
  ) +
  geom_errorbar(
    aes(
      xmin = estimate - 1.96*std.error,
      xmax = estimate + 1.96*std.error
    ),
    position = position_dodge(width = 0.7),
    linewidth = 0.5, alpha = .7
  ) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(strip.text = element_text(face = "bold.italic")) +
  labs(
    x = "Effect Estimation", y = "", color = "Attributes", title = "Candidate Experiment Fitted by Logistic Regression"
  ) +
  # scale_y_discrete(limits = rev(levels("term"))) +
  theme(
    legend.position = "none",
    text = element_text(size = 12),
    strip.text = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.text = element_text(size = 12)
  ) +
  theme_light()

ggsave("./1-figure/res-candidate-logit.png", logit.plot.candidate)
logit.plot.candidate
```


### Conditional Logistic Regression

```{r candidate-cl}
# original conditional logistic regression
cl.candidate <- clogit(
  select ~ MilitaryService. + Religion. + College. + Profession. + Income. + RaceEthnicity. + Age. + Gender. + strata(trial_id),
  data = candidate
) %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  separate_wider_delim(term, ".", names = c("attribute", "term"), too_many = "merge")

# original conditional logistic regression with clustered standard error
cl_clustered.candidate <- clogit(
  select ~ MilitaryService. + Religion. + College. + Profession. + Income. + RaceEthnicity. + Age. + Gender. + strata(trial_id),
  data = candidate, method = "efron", cluster = candidate[["subject"]]
) %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  separate_wider_delim(term, ".", names = c("attribute", "term"), too_many = "merge")

# store the result
est.all.candidate <- cl.candidate %>% 
  select(-c(statistic, p.value)) %>% 
  mutate(
    CI.lower = estimate - 1.96*std.error,
    CI.upper = estimate + 1.96*std.error
  ) %>% 
  rename_with(~ paste0(.x, ".CL"), .cols = -c(attribute, term)) %>% 
  left_join(est.all.candidate, ., by = join_by(attribute, term))
est.all.candidate <- cl_clustered.candidate %>% 
  select(-c(statistic, p.value)) %>% 
  mutate(
    CI.lower = estimate - 1.96*robust.se,
    CI.upper = estimate + 1.96*robust.se
  ) %>% 
  rename_with(~ paste0(.x, ".CL_clustered"), .cols = -c(attribute, term)) %>% 
  left_join(est.all.candidate, ., by = join_by(attribute, term))
```


``` {r candidate-cl-res}
cl.candidate %>% 
  mutate_if(is.numeric, ~ round(.x, 3)) %>% 
  kable("html", caption="Result of Conditional Logistic Regression") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  scroll_box(height = "500pt")
```


```{r candidate-cl-plot, message=F}
cl.plot.candidate <- 0
# cl.candidate %>% 
est.all.candidate %>% 
  select(1:2 | ends_with(".CL") | ends_with(".CL_clustered")) %>% 
  select(1:2 | starts_with("estimate") | starts_with("CI")) %>% 
  mutate(term = factor(term, levels = rev(term))) %>%
  # pivot_longer(starts_with("estimate"), names_to = "model", names_prefix = "estimate.", values_to = "estimate") %>% 
  pivot_longer(-(1:2), cols_vary = "slowest", names_to = c(".value", "model"), names_pattern = "(.*)\\.(.*)") %>% 
  ggplot(aes(x = estimate, y = term, color = model)) +
  geom_point(
    # position = position_dodge(width = 0.6),
    alpha = .7
  ) +
  geom_errorbar(
    aes(
      xmin = CI.lower,
      xmax = CI.upper
    ),
    # position = position_dodge(width = 0.6),
    linewidth = 0.5, alpha = .7
  ) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    x = "Effect Estimation", y = "", color = "w/ or w/o cluster se", title = "Candidate Experiment Fitted by Conditional Logistic"
  ) +
  theme(
    text = element_text(size = 12),
    strip.text = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.text = element_text(size = 12)
  ) +
  theme_light()

# ggsave("./1-figure/res-candidate-CL.png", cl.plot.candidate)
cl.plot.candidate
```


## Result Comparison

### Logistic and Conditional Logistic Regression

```{r plot-all}
est.all.candidate %>% 
  select(-ends_with("OLS")) %>% 
  mutate(term = factor(term, levels = rev(term))) %>% 
  pivot_longer(
    cols = -term,
    names_to = c(".value", "model"),
    names_pattern = "(.*)\\.(OLS|BL|CL)$"
  ) %>%  
  mutate(
    model = fct_recode(model, "Logistic" = "BL", "Conditional logistic" = "CL")
  ) %>% 
  ggplot(aes(x=estimate, y=term, col=model)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(alpha=.7) +
  geom_errorbar(
    aes(xmin = CI.lower, xmax = CI.upper), 
    alpha=.7, linewidth=.5
  ) +
  # facet_grid(attribute ~ ., space = "free", scales = "free_y") +
  labs(
    x = "Effect estimate", y="", col="Model",
    title = "Candidate Experiment: Comparison Between Logistic and Conditional Logistic"
  )+
  theme_light() +
  theme(
      legend.position = "bottom",
      text = element_text(size = 12),
      strip.text = element_text(size = 12),
      axis.text.y = element_text(size = 8),
      legend.text = element_text(size = 12),
      plot.title.position = "plot"
    )
ggsave("./1-figure/res-candidate-BL+CL.png")
```


